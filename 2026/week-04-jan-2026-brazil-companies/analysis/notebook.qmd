---
title: "TidyTuesday 2026 Week 04"
format:
  html:
    theme: cosmo
    code-fold: false
    toc: true
    embed-resources: true
execute:
  echo: true
  warning: false
  message: false
---

```{r}
library(tidyverse)
library(tidytuesdayR)
library(camcorder)
library(here)
library(showtext)

# Set working directory
setwd(here::here("2026/week-04-jan-2026-brazil-companies"))

font_add_google("Atkinson Hyperlegible", "atkinson")
showtext_auto()

# Load data
tuesdata <- tt_load(2026, week = 04)
```

```{r}
library(ggmosaic)
showtext_opts(dpi = 200)

df <- tuesdata$companies %>%
  mutate(
    legal_nature = case_when(
      str_detect(legal_nature, "Limited Liability") ~ "LLC",
      str_detect(legal_nature, "Sole Proprietorship") ~ "Sole Prop",
      str_detect(legal_nature, "Privately Held") ~ "Corp",
      TRUE ~ "Other"
    ),
    company_size = factor(
      company_size,
      levels = c("other", "small-enterprise", "micro-enterprise"),
      labels = c("Medium/Large", "Small", "Micro")
    )
  )

p1 <- ggplot(data = df) +
  geom_mosaic(
    aes(x = product(company_size, legal_nature), fill = company_size),
    color = "white",
    size = 10.1
  ) +
  scale_fill_manual(
    values = c(
      "Medium/Large" = "#fe672a",
      "Small" = "#fef37a",
      "Micro" = "#cccccc"
    )
  )

p1_data <- ggplot_build(p1)$data[[1]] %>%
  filter(.wt > 0)

calc_percentages <- function(ymax_vals) {
  diffs <- c(ymax_vals, 1) - c(0, ymax_vals)
  diffs[-length(diffs)]
}

percentages <- p1_data %>%
  group_by(x__legal_nature) %>%
  arrange(x__legal_nature, ymin) %>%
  mutate(
    perc = calc_percentages(ymax),
    percentage_label = case_when(
      x__legal_nature == "LLC" ~ paste0(
        x__fill__company_size,
        "\n",
        percent(perc, accuracy = 1)
      ),
      (ymax - ymin) > 0.1 & (xmax - xmin) > 0.1 ~ percent(perc, accuracy = 1),
      TRUE ~ ""
    ),
    x_center = (xmin + xmax) / 2,
    y_center = (ymin + ymax) / 2
  ) %>%
  ungroup()

y_labels <- percentages %>%
  group_by(x__legal_nature) %>%
  summarize(
    x_center = mean(c(min(xmin), max(xmax))), # x position of the band
    .groups = "drop"
  )

p2 <- p1 +
  geom_text(
    data = percentages,
    aes(x = x_center, y = y_center, label = percentage_label),
    color = "#333333",
    fontface = "bold",
    family = "atkinson",
    size = 5.5,
    lineheight = 0.8,
    inherit.aes = FALSE
  ) +
  geom_text(
    data = y_labels,
    aes(x = x_center, y = 1.01, label = x__legal_nature), # y = 1.05 to place outside
    color = "#333333",
    family = "atkinson",
    fontface = "bold",
    size = 6,
    vjust = 0,
    hjust = 0,
    inherit.aes = FALSE
  ) +
  coord_flip(clip = "off") +
  labs(
    title = "LLCs dominate the Brazilian landscape",
    subtitle = "Over 84% of Brazilian businesses operate as limited liability companies,\nwith micro and small enterprises making up the bulk of the market",
    caption = "Source: TidyTuesday Week 03-26, Receita Federal | Visualization: Aman Bhargava @aman.bh",
    x = NULL,
    y = NULL
  ) +
  theme_minimal(base_family = "Arial") +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    plot.title = element_text(
      family = "atkinson",
      color = "#333333",
      size = 36,
      face = "bold",
      margin = margin(b = 16, t = 12, l = 28)
    ),
    plot.subtitle = element_text(
      family = "atkinson",
      color = "#333333",
      size = 20,
      lineheight = 0.8,
      margin = margin(b = 4, l = 28)
    ),
    plot.margin = margin(20, 48, 32, 8),
    legend.position = "none",
    plot.caption = element_text(
      color = "#535353",
      hjust = 0.1,
      family = "atkinson",
      size = 16,
      margin = margin(t = 4, l = 10)
    )
  )

p2

ggsave("output/plot.png", p2, width = 2800, height = 2000, units = "px")

```